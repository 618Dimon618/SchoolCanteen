{% extends 'base.html' %}
{% block content %}
<div class="dashboard">
    <h1>üìñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–ª—é–¥–∞–º–∏</h1>

    <div class="section">
        <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –±–ª—é–¥–æ</h2>
        <form method="POST" action="{{ url_for('create_dish') }}" class="create-dish-form">
            <div class="form-row">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" name="dish_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞" required>
                </div>
                <div class="form-group">
                    <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
                    <input type="number" name="dish_price" placeholder="0" min="0" step="1" required>
                </div>
                <div class="form-group">
                    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select name="dish_category" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }} ({{ '–ó–∞–≤—Ç—Ä–∞–∫' if cat.meal_type == 'breakfast' else '–û–±–µ–¥' }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>–ê–ª–ª–µ—Ä–≥–µ–Ω—ã</label>
                <div class="allergy-checkboxes">
                    {% for allergy in allergies %}
                    <label class="allergy-checkbox">
                        <input type="checkbox" name="dish_allergies" value="{{ allergy.id }}">
                        {{ allergy.name }}
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="form-group">
                <label>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</label>
                <div id="ingredients-container">
                    <div class="ingredient-row">
                        <select name="ing_product[]">
                            <option value="">–ü—Ä–æ–¥—É–∫—Ç</option>
                            {% for p in products %}
                            <option value="{{ p.id }}">{{ p.name }} ({{ p.unit }})</option>
                            {% endfor %}
                        </select>
                        <input type="number" name="ing_qty[]" placeholder="–ö–æ–ª-–≤–æ" min="0.001" step="0.001">
                    </div>
                </div>
                <button type="button" onclick="addIngredient()" class="btn-small" style="margin-top:8px;">+ –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</button>
            </div>

            <button type="submit" class="btn btn-success" style="margin-top:15px;">–°–æ–∑–¥–∞—Ç—å –±–ª—é–¥–æ</button>
        </form>
    </div>

    <div class="section">
        <h2>üåÖ –ó–∞–≤—Ç—Ä–∞–∫</h2>
        {% for category, items in breakfast_dishes.items() %}
        <h4 style="margin: 15px 0 8px; color: #7f8c8d;">{{ category.name }}</h4>
        {% for item in items %}
        <div class="dish-manage-card {% if not item.is_available %}dish-disabled{% endif %}">
            <div class="dish-manage-header">
                <span class="dish-manage-name">{{ item.name }} ‚Äî {{ item.price }}‚ÇΩ</span>
                <div class="dish-manage-actions">
                    {% if dish_can_cook.get(item.id, false) %}
                    <span class="dish-status-ok">‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ</span>
                    {% elif not item.is_available %}
                    <span class="dish-status-off">üö´ –û—Ç–∫–ª—é—á–µ–Ω–æ</span>
                    {% else %}
                    <span class="dish-status-no-stock">‚ùå –ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤</span>
                    {% endif %}
                    <a href="{{ url_for('toggle_item', item_id=item.id) }}" class="btn-small {% if item.is_available %}btn-danger{% else %}btn-success{% endif %}">
                        {% if item.is_available %}–û—Ç–∫–ª—é—á–∏—Ç—å{% else %}–í–∫–ª—é—á–∏—Ç—å{% endif %}
                    </a>
                    <a href="{{ url_for('delete_dish', item_id=item.id) }}" class="btn-small btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –±–ª—é–¥–æ?')">üóëÔ∏è</a>
                </div>
            </div>
            {% if dish_ingredients.get(item.id) %}
            <div class="dish-ingredients-list">
                {% for ing in dish_ingredients[item.id] %}
                <span class="ingredient-tag {% if ing.product.quantity < ing.quantity %}ingredient-low{% endif %}">
                    {{ ing.product.name }}:
                    {% if ing.product.unit == '—à—Ç' %}
                        {{ ing.quantity | int }} —à—Ç
                    {% elif ing.product.unit == '–∫–≥' %}
                        {% if ing.quantity >= 1 %}{{ ing.quantity | round(2) }} –∫–≥{% else %}{{ (ing.quantity * 1000) | round(0) | int }} –≥{% endif %}
                    {% elif ing.product.unit == '–ª' %}
                        {% if ing.quantity >= 1 %}{{ ing.quantity | round(2) }} –ª{% else %}{{ (ing.quantity * 1000) | round(0) | int }} –º–ª{% endif %}
                    {% else %}
                        {{ ing.quantity | round(2) }} {{ ing.product.unit }}
                    {% endif %}
                    (—Å–∫–ª–∞–¥: {{ ing.product.quantity | round(2) }} {{ ing.product.unit }})
                </span>
                {% endfor %}
            </div>
            {% else %}
            <div class="dish-ingredients-list">
                <span class="ingredient-tag">–ù–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤</span>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% endfor %}
    </div>

    <div class="section">
        <h2>üçΩÔ∏è –û–±–µ–¥</h2>
        {% for category, items in lunch_dishes.items() %}
        <h4 style="margin: 15px 0 8px; color: #7f8c8d;">{{ category.name }}</h4>
        {% for item in items %}
        <div class="dish-manage-card {% if not item.is_available %}dish-disabled{% endif %}">
            <div class="dish-manage-header">
                <span class="dish-manage-name">{{ item.name }} ‚Äî {{ item.price }}‚ÇΩ</span>
                <div class="dish-manage-actions">
                    {% if dish_can_cook.get(item.id, false) %}
                    <span class="dish-status-ok">‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ</span>
                    {% elif not item.is_available %}
                    <span class="dish-status-off">üö´ –û—Ç–∫–ª—é—á–µ–Ω–æ</span>
                    {% else %}
                    <span class="dish-status-no-stock">‚ùå –ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤</span>
                    {% endif %}
                    <a href="{{ url_for('toggle_item', item_id=item.id) }}" class="btn-small {% if item.is_available %}btn-danger{% else %}btn-success{% endif %}">
                        {% if item.is_available %}–û—Ç–∫–ª—é—á–∏—Ç—å{% else %}–í–∫–ª—é—á–∏—Ç—å{% endif %}
                    </a>
                    <a href="{{ url_for('delete_dish', item_id=item.id) }}" class="btn-small btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –±–ª—é–¥–æ?')">üóëÔ∏è</a>
                </div>
            </div>
            {% if dish_ingredients.get(item.id) %}
            <div class="dish-ingredients-list">
                {% for ing in dish_ingredients[item.id] %}
                <span class="ingredient-tag {% if ing.product.quantity < ing.quantity %}ingredient-low{% endif %}">
                    {{ ing.product.name }}:
                    {% if ing.product.unit == '—à—Ç' %}
                        {{ ing.quantity | int }} —à—Ç
                    {% elif ing.product.unit == '–∫–≥' %}
                        {% if ing.quantity >= 1 %}{{ ing.quantity | round(2) }} –∫–≥{% else %}{{ (ing.quantity * 1000) | round(0) | int }} –≥{% endif %}
                    {% elif ing.product.unit == '–ª' %}
                        {% if ing.quantity >= 1 %}{{ ing.quantity | round(2) }} –ª{% else %}{{ (ing.quantity * 1000) | round(0) | int }} –º–ª{% endif %}
                    {% else %}
                        {{ ing.quantity | round(2) }} {{ ing.product.unit }}
                    {% endif %}
                    (—Å–∫–ª–∞–¥: {{ ing.product.quantity | round(2) }} {{ ing.product.unit }})
                </span>
                {% endfor %}
            </div>
            {% else %}
            <div class="dish-ingredients-list">
                <span class="ingredient-tag">–ù–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤</span>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% endfor %}
    </div>
</div>

<script>
function addIngredient() {
    var container = document.getElementById('ingredients-container');
    var row = document.createElement('div');
    row.className = 'ingredient-row';
    row.innerHTML = container.querySelector('.ingredient-row').innerHTML;
    var selects = row.querySelectorAll('select');
    selects.forEach(function(s) { s.value = ''; });
    var inputs = row.querySelectorAll('input');
    inputs.forEach(function(i) { i.value = ''; });
    var removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn-small btn-danger';
    removeBtn.textContent = '‚úï';
    removeBtn.onclick = function() { row.remove(); };
    row.appendChild(removeBtn);
    container.appendChild(row);
}
</script>
{% endblock %}
