{% extends 'base.html' %}
{% block content %}
<div class="dashboard">
    <h1>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>üí∞ –ü—Ä–∏–±—ã–ª—å</h3>
            <p class="big-number">{{ stats.total_income }} ‚ÇΩ</p>
            <small>–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã: {{ stats.subscriptions }}‚ÇΩ | –ü–æ–∫—É–ø–∫–∏: {{ stats.purchases }}‚ÇΩ</small>
        </div>
        <div class="stat-card">
            <h3>üìâ –†–∞—Å—Ö–æ–¥—ã</h3>
            <p class="big-number">{{ expenses }} ‚ÇΩ</p>
            <small>–ù–∞ –∑–∞–∫—É–ø–∫—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤</small>
        </div>
        <div class="stat-card">
            <h3>üìä –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</h3>
            <p class="big-number {% if stats.total_income - expenses > 0 %}positive{% else %}negative{% endif %}">
                {{ stats.total_income - expenses }} ‚ÇΩ
            </p>
        </div>
        <div class="stat-card">
            <h3>üçΩÔ∏è –ó–∞–∫–∞–∑—ã</h3>
            <p class="big-number">{{ order_stats.total }}</p>
            <small>–°–µ–≥–æ–¥–Ω—è: {{ order_stats.today }} | –ü–æ–ª—É—á–µ–Ω–æ: {{ order_stats.received }}</small>
        </div>
        <div class="stat-card">
            <h3>üåÖ –ó–∞–≤—Ç—Ä–∞–∫–∏</h3>
            <p class="big-number">{{ total_breakfasts }}</p>
            <small>–°–µ–≥–æ–¥–Ω—è: {{ breakfast_today }}</small>
        </div>
        <div class="stat-card">
            <h3>üç≤ –û–±–µ–¥—ã</h3>
            <p class="big-number">{{ total_lunches }}</p>
            <small>–°–µ–≥–æ–¥–Ω—è: {{ lunch_today }}</small>
        </div>
    </div>

    <div class="section">
        <a href="{{ url_for('download_report') }}" class="btn">üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç (Excel)</a>
    </div>

    {% if pending_users %}
    <div class="section">
        <h2>üë§ –ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</h2>
        <table>
            <tr>
                <th>–õ–æ–≥–∏–Ω</th>
                <th>–§–ò–û</th>
                <th>–ö–ª–∞—Å—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            {% for u in pending_users %}
            <tr>
                <td>{{ u.username }}</td>
                <td>{{ u.full_name or '-' }}</td>
                <td>{{ u.class_name or '-' }}</td>
                <td>
                    <a href="{{ url_for('approve_user', user_id=u.id) }}" class="btn-small btn-success">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</a>
                    <a href="{{ url_for('reject_user', user_id=u.id) }}" class="btn-small btn-danger">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</a>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% endif %}

    <div class="section">
        <h2>‚è≥ –ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</h2>
        {% if pending %}
        <table>
            <tr>
                <th>–î–∞—Ç–∞</th>
                <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                <th>–ö–æ–ª-–≤–æ</th>
                <th>–°—É–º–º–∞</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            {% for req in pending %}
            <tr>
                <td>{{ req.date.strftime('%d.%m.%Y') }}</td>
                <td>{{ req.product.name }}</td>
                <td>{{ req.quantity }} {{ req.product.unit }}</td>
                <td>{{ (req.quantity * req.product.price)|round(2) }} ‚ÇΩ</td>
                <td>
                    <a href="{{ url_for('approve', req_id=req.id) }}" class="btn-small btn-success">–û–¥–æ–±—Ä–∏—Ç—å</a>
                    <a href="{{ url_for('reject', req_id=req.id) }}" class="btn-small btn-danger">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</a>
                </td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p>–ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</p>
        {% endif %}
    </div>

    <div class="section">
        <h2>üìã –í—Å–µ –∑–∞—è–≤–∫–∏</h2>
        {% if all_requests %}
        <table>
            <tr>
                <th>–î–∞—Ç–∞</th>
                <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                <th>–ö–æ–ª-–≤–æ</th>
                <th>–°—É–º–º–∞</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
            {% for req in all_requests %}
            <tr>
                <td>{{ req.date.strftime('%d.%m.%Y') }}</td>
                <td>{{ req.product.name }}</td>
                <td>{{ req.quantity }} {{ req.product.unit }}</td>
                <td>{{ (req.quantity * req.product.price)|round(2) }} ‚ÇΩ</td>
                <td>
                    {% if req.status == 'pending' %}‚è≥ –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏
                    {% elif req.status == 'approved' %}‚úÖ –û–¥–æ–±—Ä–µ–Ω–∞
                    {% else %}‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∞{% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p>–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</p>
        {% endif %}
    </div>

    <div class="section">
        <h2>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
        <table>
            <tr>
                <th>ID</th>
                <th>–õ–æ–≥–∏–Ω</th>
                <th>–§–ò–û</th>
                <th>–†–æ–ª—å</th>
                <th>–ë–∞–ª–∞–Ω—Å</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
            {% for u in users %}
            <tr>
                <td>{{ u.id }}</td>
                <td>{{ u.username }}</td>
                <td>{{ u.full_name or '-' }}</td>
                <td>{% if u.role == 'student' %}–£—á–µ–Ω–∏–∫{% elif u.role == 'cook' %}–ü–æ–≤–∞—Ä{% elif u.role == 'admin' %}–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä{% else %}{{ u.role }}{% endif %}</td>
                <td>{{ u.balance }} ‚ÇΩ</td>
                <td>{% if u.is_approved %}‚úÖ{% else %}‚è≥{% endif %}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
</div>
{% endblock %}
