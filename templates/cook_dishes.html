{% extends 'base.html' %}
{% block content %}
<div class="dashboard">
    <h1>Управление блюдами</h1>

    <div class="section">
        <h2>Создать новое блюдо</h2>
        <form method="POST" action="{{ url_for('create_dish') }}" class="create-dish-form">
            <div class="form-row">
                <div class="form-group">
                    <label>Название</label>
                    <input type="text" name="dish_name" placeholder="Название блюда" required>
                </div>
                <div class="form-group">
                    <label>Цена (руб.)</label>
                    <input type="number" name="dish_price" placeholder="0" min="0" step="1" required>
                </div>
                <div class="form-group">
                    <label>Категория</label>
                    <select name="dish_category" required>
                        <option value="">Выберите</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }} ({{ 'Завтрак' if cat.meal_type == 'breakfast' else 'Обед' }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Аллергены</label>
                <div class="allergy-checkboxes">
                    {% for allergy in allergies %}
                    <label class="allergy-checkbox">
                        <input type="checkbox" name="dish_allergies" value="{{ allergy.id }}">
                        {{ allergy.name }}
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="form-group">
                <label>Ингредиенты</label>
                <div id="ingredients-container">
                    <div class="ingredient-row">
                        <select name="ing_product[]">
                            <option value="">Продукт</option>
                            {% for p in products %}
                            <option value="{{ p.id }}">{{ p.name }} ({{ p.unit }})</option>
                            {% endfor %}
                        </select>
                        <input type="number" name="ing_qty[]" placeholder="Кол-во" min="0.001" step="0.001">
                    </div>
                </div>
                <button type="button" onclick="addIngredient()" class="btn-small" style="margin-top:8px;">+ Добавить ингредиент</button>
            </div>

            <button type="submit" class="btn btn-success" style="margin-top:15px;">Создать блюдо</button>
        </form>
    </div>

    <div class="section">
        <h2>Завтрак</h2>
        {% for category, items in breakfast_dishes.items() %}
        <h4 style="margin: 15px 0 8px; color: #7f8c8d;">{{ category.name }}</h4>
        {% for item in items %}
        <div class="dish-manage-card {% if not item.is_available %}dish-disabled{% endif %}">
            <div class="dish-manage-header">
                <span class="dish-manage-name">{{ item.name }} - {{ item.price }} руб.</span>
                <div class="dish-manage-actions">
                    {% if dish_can_cook.get(item.id, false) %}
                    <span class="dish-status-ok">[Доступно]</span>
                    {% elif not item.is_available %}
                    <span class="dish-status-off">[Отключено]</span>
                    {% else %}
                    <span class="dish-status-no-stock">[Нет продуктов]</span>
                    {% endif %}
                    <a href="{{ url_for('toggle_item', item_id=item.id) }}" class="btn-small {% if item.is_available %}btn-danger{% else %}btn-success{% endif %}">
                        {% if item.is_available %}Отключить{% else %}Включить{% endif %}
                    </a>
                    <a href="{{ url_for('delete_dish', item_id=item.id) }}" class="btn-small btn-danger" onclick="return confirm('Удалить блюдо?')">Удалить</a>
                </div>
            </div>
            {% if dish_ingredients.get(item.id) %}
            <div class="dish-ingredients-list">
                {% for ing in dish_ingredients[item.id] %}
                <span class="ingredient-tag {% if ing.quantity > ing.product.quantity %}ingredient-low{% endif %}">
                    {{ ing.product.name }}:
                    {% if ing.product.unit == 'шт' %}
                        {{ ing.quantity | int }} шт
                    {% elif ing.product.unit == 'кг' %}
                        {% if ing.quantity >= 1 %}{{ ing.quantity | round(2) }} кг{% else %}{{ (ing.quantity * 1000) | round(0) | int }} г{% endif %}
                    {% elif ing.product.unit == 'л' %}
                        {% if ing.quantity >= 1 %}{{ ing.quantity | round(2) }} л{% else %}{{ (ing.quantity * 1000) | round(0) | int }} мл{% endif %}
                    {% else %}
                        {{ ing.quantity | round(2) }} {{ ing.product.unit }}
                    {% endif %}
                    (склад: {{ ing.product.quantity | round(2) }} {{ ing.product.unit }})
                </span>
                {% endfor %}
            </div>
            {% else %}
            <div class="dish-ingredients-list">
                <span class="ingredient-tag">Нет ингредиентов</span>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% endfor %}
    </div>

    <div class="section">
        <h2>Обед</h2>
        {% for category, items in lunch_dishes.items() %}
        <h4 style="margin: 15px 0 8px; color: #7f8c8d;">{{ category.name }}</h4>
        {% for item in items %}
        <div class="dish-manage-card {% if not item.is_available %}dish-disabled{% endif %}">
            <div class="dish-manage-header">
                <span class="dish-manage-name">{{ item.name }} - {{ item.price }} руб.</span>
                <div class="dish-manage-actions">
                    {% if dish_can_cook.get(item.id, false) %}
                    <span class="dish-status-ok">[Доступно]</span>
                    {% elif not item.is_available %}
                    <span class="dish-status-off">[Отключено]</span>
                    {% else %}
                    <span class="dish-status-no-stock">[Нет продуктов]</span>
                    {% endif %}
                    <a href="{{ url_for('toggle_item', item_id=item.id) }}" class="btn-small {% if item.is_available %}btn-danger{% else %}btn-success{% endif %}">
                        {% if item.is_available %}Отключить{% else %}Включить{% endif %}
                    </a>
                    <a href="{{ url_for('delete_dish', item_id=item.id) }}" class="btn-small btn-danger" onclick="return confirm('Удалить блюдо?')">Удалить</a>
                </div>
            </div>
            {% if dish_ingredients.get(item.id) %}
            <div class="dish-ingredients-list">
                {% for ing in dish_ingredients[item.id] %}
                <span class="ingredient-tag {% if ing.quantity > ing.product.quantity %}ingredient-low{% endif %}">
                    {{ ing.product.name }}:
                    {% if ing.product.unit == 'шт' %}
                        {{ ing.quantity | int }} шт
                    {% elif ing.product.unit == 'кг' %}
                        {% if ing.quantity >= 1 %}{{ ing.quantity | round(2) }} кг{% else %}{{ (ing.quantity * 1000) | round(0) | int }} г{% endif %}
                    {% elif ing.product.unit == 'л' %}
                        {% if ing.quantity >= 1 %}{{ ing.quantity | round(2) }} л{% else %}{{ (ing.quantity * 1000) | round(0) | int }} мл{% endif %}
                    {% else %}
                        {{ ing.quantity | round(2) }} {{ ing.product.unit }}
                    {% endif %}
                    (склад: {{ ing.product.quantity | round(2) }} {{ ing.product.unit }})
                </span>
                {% endfor %}
            </div>
            {% else %}
            <div class="dish-ingredients-list">
                <span class="ingredient-tag">Нет ингредиентов</span>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% endfor %}
    </div>
</div>

<script>
function addIngredient() {
    var container = document.getElementById('ingredients-container');
    var row = document.createElement('div');
    row.className = 'ingredient-row';
    row.innerHTML = container.querySelector('.ingredient-row').innerHTML;
    var selects = row.querySelectorAll('select');
    selects.forEach(function(s) { s.value = ''; });
    var inputs = row.querySelectorAll('input');
    inputs.forEach(function(i) { i.value = ''; });
    var removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn-small btn-danger';
    removeBtn.textContent = 'X';
    removeBtn.onclick = function() { row.remove(); };
    row.appendChild(removeBtn);
    container.appendChild(row);
}
</script>
{% endblock %}
