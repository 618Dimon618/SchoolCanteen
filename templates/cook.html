{% extends 'base.html' %}
{% block content %}
<div class="dashboard">
    <h1>–ü–∞–Ω–µ–ª—å –ø–æ–≤–∞—Ä–∞</h1>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>üåÖ –ó–∞–≤—Ç—Ä–∞–∫–æ–≤ —Å–µ–≥–æ–¥–Ω—è</h3>
            <p class="big-number">{{ breakfast_count }}</p>
        </div>
        <div class="stat-card">
            <h3>üçΩÔ∏è –û–±–µ–¥–æ–≤ —Å–µ–≥–æ–¥–Ω—è</h3>
            <p class="big-number">{{ lunch_count }}</p>
        </div>
        <div class="stat-card">
            <h3>‚úÖ –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–æ</h3>
            <p class="big-number">{{ prepared_count }}</p>
        </div>
        <div class="stat-card">
            <h3>üì¶ –í—ã–¥–∞–Ω–æ</h3>
            <p class="big-number">{{ received_count }}</p>
        </div>
    </div>

    <div class="section">
        <h2>üç≥ –ó–∞–∫–∞–∑—ã –∫ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—é</h2>
        {% if orders %}
        {% for order in orders %}
        <div class="cook-order-card">
            <div class="cook-order-header">
                <span class="cook-order-icon">üìã –ó–∞–∫–∞–∑ #{{ order.id }}</span>
                <span>{{ order.user.full_name or order.user.username }}</span>
                <span>{{ '–ó–∞–≤—Ç—Ä–∞–∫' if order.meal_type == 'breakfast' else '–û–±–µ–¥' }}</span>
                <span>{{ order.created_at.strftime('%H:%M') }}</span>
            </div>
            <div class="cook-order-items-list">
                {% for oi in order.items %}
                <div class="cook-item-row {% if oi.is_cooked %}cooked{% endif %}">
                    <span class="cook-item-name">
                        {% if oi.is_cooked %}‚úÖ{% else %}‚¨ú{% endif %}
                        {{ oi.menu_item.name }} ‚Äî {{ oi.price }}‚ÇΩ
                    </span>
                    {% if oi.is_cooked %}
                    <span class="cook-item-status-done">–ì–æ—Ç–æ–≤–æ</span>
                    {% else %}
                    {% if order_item_can_cook.get(oi.id, false) %}
                    <a href="{{ url_for('cook_item', oi_id=oi.id) }}" class="btn-small btn-cook">üî• –ü—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å</a>
                    {% else %}
                    <span class="cook-item-no-stock">‚ùå –ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤</span>
                    {% endif %}
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% set ns = namespace(fully_cooked=true) %}
            {% for oi in order.items %}
                {% if not oi.is_cooked %}{% set ns.fully_cooked = false %}{% endif %}
            {% endfor %}
            {% if ns.fully_cooked %}
            <div class="cook-order-ready">
                <a href="{{ url_for('prepare_order', order_id=order.id) }}" class="btn btn-success">üì¶ –ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ</a>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <p>–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –∫ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—é</p>
        {% endif %}
    </div>

    <div class="section">
        <h2>üì¶ –û—Å—Ç–∞—Ç–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h2>
        <table>
            <tr><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th><th>–ï–¥.</th></tr>
            {% for product in products %}
            <tr class="{% if product.quantity < 10 %}low-stock{% endif %}">
                <td>{{ product.name }}</td>
                <td>{% if product.unit == '—à—Ç' %}{{ product.quantity | round(0) | int }}{% else %}{{ product.quantity | round(2) }}{% endif %}</td>
                <td>{{ product.unit }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <div class="section">
        <h2>üìù –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –∑–∞–∫—É–ø–∫—É</h2>
        <form method="POST" action="{{ url_for('add_request') }}" class="inline-form">
            <select name="product_id" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</option>
                {% for product in products %}
                <option value="{{ product.id }}">{{ product.name }}</option>
                {% endfor %}
            </select>
            <input type="number" name="quantity" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" min="1" required>
            <button type="submit">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
        </form>
    </div>

    <div class="section">
        <h2>üìã –ú–æ–∏ –∑–∞—è–≤–∫–∏</h2>
        {% if my_requests %}
        <table>
            <tr><th>–î–∞—Ç–∞</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–ö–æ–ª-–≤–æ</th><th>–°—Ç–∞—Ç—É—Å</th></tr>
            {% for req in my_requests %}
            <tr>
                <td>{{ req.date.strftime('%d.%m.%Y') }}</td>
                <td>{{ req.product.name }}</td>
                <td>{{ req.quantity }}</td>
                <td>{% if req.status == 'pending' %}‚è≥ –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏{% elif req.status == 'approved' %}‚úÖ –û–¥–æ–±—Ä–µ–Ω–∞{% else %}‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∞{% endif %}</td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p>–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</p>
        {% endif %}
    </div>
</div>
{% endblock %}
