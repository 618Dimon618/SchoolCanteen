{% extends 'base.html' %}
{% block content %}
<div class="dashboard">
    <h1>–ü–∞–Ω–µ–ª—å –ø–æ–≤–∞—Ä–∞</h1>

    <div class="section">
        <h2>üç≥ –ó–∞–∫–∞–∑—ã –∫ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—é</h2>
        {% if orders %}
        {% for order in orders %}
        <div class="cook-order-card">
            <div class="cook-order-header">
                <span class="cook-order-icon">üìã –ó–∞–∫–∞–∑ #{{ order.id }}</span>
                <span>{{ order.user.full_name or order.user.username }}</span>
                <span>{{ '–ó–∞–≤—Ç—Ä–∞–∫' if order.meal_type == 'breakfast' else '–û–±–µ–¥' }}</span>
                <span>{{ order.date }}</span>
                <a href="{{ url_for('prepare_order', order_id=order.id) }}" class="btn-small btn-success">‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –≤—ã–¥–∞—á–µ</a>
            </div>
            {% for oi in order.items %}
            <div class="cook-dish-block">
                <div class="cook-dish-name">üçΩÔ∏è {{ oi.menu_item.name }}</div>
                {% set ingredients = order_ingredients.get(oi.menu_item.id, []) %}
                {% if ingredients %}
                <div class="cook-ingredients">
                    {% for ing in ingredients %}
                    <span class="ingredient-tag">{{ ing.product.name }}:
                        {% if ing.product.unit == '—à—Ç' %}
                            {{ ing.quantity | int }} —à—Ç
                        {% elif ing.product.unit == '–∫–≥' %}
                            {% if ing.quantity >= 1 %}
                                {{ ing.quantity | round(2) }} –∫–≥
                            {% else %}
                                {{ (ing.quantity * 1000) | round(0) | int }} –≥
                            {% endif %}
                        {% elif ing.product.unit == '–ª' %}
                            {% if ing.quantity >= 1 %}
                                {{ ing.quantity | round(2) }} –ª
                            {% else %}
                                {{ (ing.quantity * 1000) | round(0) | int }} –º–ª
                            {% endif %}
                        {% else %}
                            {{ ing.quantity | round(2) }} {{ ing.product.unit }}
                        {% endif %}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endfor %}
        {% else %}
        <p>–í—Å–µ –∑–∞–∫–∞–∑—ã –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω—ã!</p>
        {% endif %}
    </div>

    <div class="section">
        <h2>üì¶ –û—Å—Ç–∞—Ç–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h2>
        <table>
            <tr>
                <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                <th>–ï–¥.</th>
            </tr>
            {% for product in products %}
            <tr class="{% if product.quantity < 10 %}low-stock{% endif %}">
                <td>{{ product.name }}</td>
                <td>
                    {% if product.unit == '—à—Ç' %}
                        {{ product.quantity | round(0) | int }}
                    {% else %}
                        {{ product.quantity | round(2) }}
                    {% endif %}
                </td>
                <td>{{ product.unit }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <div class="section">
        <h2>üìù –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –∑–∞–∫—É–ø–∫—É</h2>
        <form method="POST" action="{{ url_for('add_request') }}" class="inline-form">
            <select name="product_id" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç</option>
                {% for product in products %}
                <option value="{{ product.id }}">{{ product.name }}</option>
                {% endfor %}
            </select>
            <input type="number" name="quantity" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" min="1" required>
            <button type="submit">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
        </form>
    </div>

    <div class="section">
        <h2>üìã –ú–æ–∏ –∑–∞—è–≤–∫–∏</h2>
        {% if my_requests %}
        <table>
            <tr>
                <th>–î–∞—Ç–∞</th>
                <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                <th>–ö–æ–ª-–≤–æ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
            {% for req in my_requests %}
            <tr>
                <td>{{ req.date.strftime('%d.%m.%Y') }}</td>
                <td>{{ req.product.name }}</td>
                <td>{{ req.quantity }}</td>
                <td>
                    {% if req.status == 'pending' %}‚è≥ –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏
                    {% elif req.status == 'approved' %}‚úÖ –û–¥–æ–±—Ä–µ–Ω–∞
                    {% else %}‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∞{% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p>–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</p>
        {% endif %}
    </div>
</div>
{% endblock %}