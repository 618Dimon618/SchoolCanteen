{% extends 'base.html' %}
{% block content %}
<div>
    <h1>Управление меню</h1>

    <div class="section">
        <div class="collapsible-header" onclick="document.getElementById('create-dish-body').classList.toggle('collapsed')">
            <h2>Добавить новое блюдо</h2>
        </div>
        <div class="collapsible-body collapsed" id="create-dish-body">
             <form method="POST" action="{{ url_for('create_dish') }}">
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 2;">
                        <label style="font-weight: 600; font-size: 13px;">Название</label>
                        <input type="text" name="dish_name" required placeholder="Например: Борщ">
                    </div>
                    <div style="flex: 1;">
                        <label style="font-weight: 600; font-size: 13px;">Цена (₽)</label>
                        <input type="number" name="dish_price" min="0" required placeholder="0">
                    </div>
                </div>
                 <div style="margin-top: 10px;">
                    <label style="font-weight: 600; font-size: 13px;">Категория</label>
                    <select name="dish_category" required>
                        <option value="">-- Выберите категорию --</option>
                        {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.name }} ({{ 'Завтрак' if cat.meal_type == 'breakfast' else 'Обед' }})</option>
                        {% endfor %}
                    </select>
                </div>
                 <div style="margin-top: 20px;">
                    <div id="ingredients-container">
                        <div class="ingredient-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <select name="ing_product[]" style="flex: 2; margin-bottom: 0;">
                                <option value="">Выберите продукт</option>
                                {% for p in products %}
                                    <option value="{{ p.id }}">{{ p.name }} ({{ p.unit }})</option>
                                {% endfor %}
                            </select>
                            <input type="number" name="ing_qty[]" placeholder="Кол-во" step="0.001" style="flex: 1; margin-bottom: 0;">
                        </div>
                    </div>
                    <button type="button" onclick="addIngredient()" class="btn-small" style="background: #e4e6ef; color: #333; margin-top: 5px;">+ Ингредиент</button>
                </div>
                <button type="submit" class="btn-success" style="width: 100%; margin-top: 25px;">Сохранить блюдо</button>
            </form>
        </div>
    </div>

    {% for meal_name, menu_list in [('Завтраки', breakfast_dishes), ('Обеды', lunch_dishes)] %}
    <div class="section">
        <h2>{{ meal_name }}</h2>
        {% for category, items in menu_list.items() %}
            <h4 style="margin: 20px 0 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">{{ category.name }}</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                {% for item in items %}
                    <div class="card" style="margin-bottom: 0; padding: 15px; display: flex; flex-direction: column; height: 100%; {% if not item.is_available %}background: #fff5f8; border-color: #ffcce0;{% endif %}">

                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 700; font-size: 16px;">{{ item.name }}</div>
                                <div style="color: #999; font-size: 13px;">{{ item.price }} ₽</div>
                            </div>

                            {% if not item.is_available %}
                            {% elif dish_can_cook.get(item.id, false) %}
                                <span class="badge badge-success">OK</span>
                            {% else %}
                                <span class="badge badge-danger">Мало продуктов</span>
                            {% endif %}
                        </div>

                        <div style="flex-grow: 1; font-size: 12px; color: #5e6278; margin-bottom: 15px;">
                            {% if dish_ingredients.get(item.id) %}
                                {% for ing in dish_ingredients[item.id] %}
                                    <span style="color: #7e8299;">{{ ing.product.name }}, </span>
                                {% endfor %}
                            {% else %}
                                <span style="color: #999; font-style: italic;">Без ингредиентов</span>
                            {% endif %}
                        </div>

                        <div style="display: flex; gap: 8px; margin-top: auto;">
                            <a href="{{ url_for('toggle_item', item_id=item.id) }}"
                               class="btn-small {% if item.is_available %}btn-soft-danger{% else %}btn-soft-success{% endif %}"
                               style="flex: 1; text-align: center; border-radius: 6px;">
                               {% if item.is_available %}
                                   В стоп-лист
                               {% else %}
                                   Вернуть в меню
                               {% endif %}
                            </a>

                            <a href="{{ url_for('delete_dish', item_id=item.id) }}"
                               class="btn-small btn-soft-danger btn-icon"
                               onclick="return confirm('Удалить блюдо навсегда?')"
                               title="Удалить">
                               ✕
                            </a>
                        </div>

                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>

<script>
function addIngredient() {
    var container = document.getElementById('ingredients-container');
    var row = container.children[0].cloneNode(true);
    var inputs = row.querySelectorAll('input, select');
    inputs.forEach(i => i.value = '');
    if (!row.querySelector('.remove-btn')) {
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.innerText = '✕';
        btn.className = 'btn-small btn-danger remove-btn';
        btn.style.width = '30px';
        btn.onclick = function() { this.parentElement.remove(); };
        row.appendChild(btn);
    }
    container.appendChild(row);
}
</script>
{% endblock %}