{% extends 'base.html' %}
{% block content %}
<div>
    <h1>Панель управления</h1>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Прибыль</h3>
            <div class="big-number">{{ stats.total_income }} ₽</div>
            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                Абонементы: {{ stats.subscriptions }} | Розница: {{ stats.purchases }}
            </div>
        </div>
        <div class="stat-card">
            <h3>Расходы</h3>
            <div class="big-number" style="color: #f1416c;">{{ expenses }} ₽</div>
            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                Закупка продуктов
            </div>
        </div>
        <div class="stat-card">
            <h3>Чистая прибыль</h3>
            <div class="big-number" style="color: {% if stats.total_income - expenses > 0 %}#50cd89{% else %}#f1416c{% endif %};">
                {{ stats.total_income - expenses }} ₽
            </div>
            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                Доход минус расходы
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Всего заказов</h3>
            <div class="big-number">{{ order_stats.total }}</div>
            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                За сегодня: {{ order_stats.today }}
            </div>
        </div>
        <div class="stat-card">
            <h3>Завтраки</h3>
            <div class="big-number">{{ total_breakfasts }}</div>
            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                За сегодня: {{ breakfast_today }}
            </div>
        </div>
        <div class="stat-card">
            <h3>Обеды</h3>
            <div class="big-number">{{ total_lunches }}</div>
            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                За сегодня: {{ lunch_today }}
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Посещаемость столовой сегодня</h2>
        {% if class_stats %}
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Класс</th>
                            <th>Посетителей (Всего)</th>
                            <th>Завтракали</th>
                            <th>Обедали</th>
                            <th>Статус</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for cls, data in class_stats.items() %}
                        <tr>
                            <td style="font-weight: 800; font-size: 16px;">{{ cls }}</td>
                            <td style="font-weight: bold; color: var(--primary);">{{ data.total }} чел.</td>
                            <td>{{ data.breakfast }}</td>
                            <td>{{ data.lunch }}</td>
                            <td>
                                {% if data.total > 20 %}
                                    <span class="badge badge-success">Высокая</span>
                                {% elif data.total > 10 %}
                                    <span class="badge badge-warning">Средняя</span>
                                {% else %}
                                    <span class="badge badge-danger">Низкая</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p style="color: #999; text-align: center; padding: 20px;">Сегодня посещений еще не зафиксировано</p>
        {% endif %}
    </div>

    <div class="section" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2>Финансовый отчет</h2>
            <p style="color: #7e8299; font-size: 14px; margin-bottom: 0;">Скачать полную статистику в формате Excel</p>
        </div>
        <a href="{{ url_for('download_report') }}" class="btn">Скачать отчет (.xlsx)</a>
    </div>

    {% if pending_users %}
    <div class="section">
        <h2 style="color: var(--danger-text);">Заявки на регистрацию</h2>
        <table>
            <thead>
                <tr>
                    <th>Логин</th>
                    <th>ФИО</th>
                    <th>Класс</th>
                    <th style="text-align: right;">Действия</th>
                </tr>
            </thead>
            <tbody>
            {% for u in pending_users %}
                <tr>
                    <td><strong>{{ u.username }}</strong></td>
                    <td>{{ u.full_name or '-' }}</td>
                    <td>{{ u.class_name or '-' }}</td>
                    <td style="text-align: right;">
                        <a href="{{ url_for('approve_user', user_id=u.id) }}" class="btn-small btn-soft-success" style="margin-right: 5px; text-decoration: none;">Принять</a>
                        <a href="{{ url_for('reject_user', user_id=u.id) }}" class="btn-small btn-soft-danger" onclick="return confirm('Отклонить пользователя?')" style="text-decoration: none;">Отклонить</a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="section">
        <h2>Заявки на закупку продуктов</h2>
        {% if pending %}
            <table>
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Продукт</th>
                        <th>Количество</th>
                        <th>Сумма</th>
                        <th style="text-align: right;">Решение</th>
                    </tr>
                </thead>
                <tbody>
                {% for req in pending %}
                    <tr>
                        <td>{{ req.date.strftime('%d.%m.%Y') }}</td>
                        <td style="font-weight: bold;">{{ req.product.name }}</td>
                        <td>{{ req.quantity }} {{ req.product.unit }}</td>
                        <td>{{ (req.quantity * req.product.price)|round(2) }} ₽</td>
                        <td style="text-align: right;">
                            <a href="{{ url_for('approve', req_id=req.id) }}" class="btn-small btn-soft-success" style="margin-right: 5px; text-decoration: none;">Одобрить</a>
                            <a href="{{ url_for('reject', req_id=req.id) }}" class="btn-small btn-soft-danger" onclick="return confirm('Отклонить заявку?')" style="text-decoration: none;">Отклонить</a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div style="text-align: center; padding: 20px; color: #999;">
                Нет активных заявок на рассмотрении
            </div>
        {% endif %}
    </div>

    <div class="section">
        <div class="collapsible-header" onclick="document.getElementById('users-body').classList.toggle('collapsed')">
            <h2>Список всех пользователей</h2>
            <span style="font-size: 12px; font-weight: 600; color: #7e8299;">Всего: {{ users|length }}</span>
        </div>

        <div class="collapsible-body collapsed" id="users-body">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Логин</th>
                        <th>ФИО</th>
                        <th>Класс</th>
                        <th>Роль</th>
                        <th>Баланс</th>
                        <th>Статус</th>
                    </tr>
                </thead>
                <tbody>
                {% for u in users %}
                    <tr>
                        <td>{{ u.id }}</td>
                        <td><strong>{{ u.username }}</strong></td>
                        <td>{{ u.full_name or '-' }}</td>
                        <td>{{ u.class_name or '-' }}</td>
                        <td>
                            {% if u.role == 'student' %}
                                <span style="background: #f5f8fa; padding: 3px 8px; border-radius: 4px; font-size: 12px; color: #5e6278;">Ученик</span>
                            {% elif u.role == 'cook' %}
                                <span style="background: #e8fff3; padding: 3px 8px; border-radius: 4px; font-size: 12px; color: #50cd89; font-weight: bold;">Повар</span>
                            {% elif u.role == 'admin' %}
                                <span style="background: #fff8dd; padding: 3px 8px; border-radius: 4px; font-size: 12px; color: #ffc700; font-weight: bold;">Админ</span>
                            {% else %}
                                {{ u.role }}
                            {% endif %}
                        </td>
                        <td>{{ u.balance }} ₽</td>
                        <td>
                            {% if u.is_approved %}
                                <span class="badge badge-success">Активен</span>
                            {% else %}
                                <span class="badge badge-warning">Ожидает</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}